CHANGES TO DATABASE

still need to be processed in a checkschema
voer deze dingen in volgorde uit...

//table 'topic' => hernoem tot table 'topics'
ALTER TABLE `topic` RENAME TO `topics`;
//col 'topics.ID' => hernoem tot 'topics.topic_id'
ALTER TABLE `topics` CHANGE COLUMN `ID` `topic_id` INT(10) NOT NULL AUTO_INCREMENT;

//table 'person' => hernoem tot table 'users'
ALTER TABLE `person` RENAME TO `users`;
//col 'users.ID' => hernoem tot 'users.user_id'
ALTER TABLE `users` CHANGE COLUMN `ID` `user_id` INT(10) NOT NULL AUTO_INCREMENT;
//add col 'users.type' (enum('group','anon','normal')
ALTER TABLE `users` ADD COLUMN `type` ENUM('group','anon','normal') NOT NULL DEFAULT 'normal' AFTER `lastreviewedtopic`;



//add table `rightsprofiles` ('rightsprofile_id' INT(10) autoinc,'name' varchar(20)) 
CREATE TABLE `rightsprofiles` (
`rightsprofile_id` INT( 10 ) NOT NULL AUTO_INCREMENT PRIMARY KEY ,
`name` VARCHAR( 20 ) NOT NULL
) 


//add table `rightsprofilerightlink` (rightsprofile_id INT(10), right_name VARCHAR(20))
CREATE TABLE `rightsprofilerightlink` (
`rightsprofile_id` INT( 10 ) NOT NULL ,
`right_name` VARCHAR( 20 ) NOT NULL ,
PRIMARY KEY (`rightsprofile_id`, `right_name` )
) 


//add table `usergrouplink` (user_id INT(10),group_id INT(10))
CREATE TABLE `usergrouplink` (
`user_id` INT( 10 ) NOT NULL ,
`group_id` INT( 10 ) NOT NULL ,
PRIMARY KEY ( `user_id` ,`group_id`)
)


CREATE TABLE `grouprightsprofilelink` (
`group_id` INT( 10 ) NOT NULL ,
`rightsprofile_id` INT( 10 ) NOT NULL ,
PRIMARY KEY ( `group_id` , `rightsprofile_id`)
)

//rename 'topicpublication' to 'topicpublicationlink'
ALTER TABLE `topicpublication` RENAME TO `topicpublicationlink`;

//rename 'persontopic' to 'usertopiclink'
ALTER TABLE `persontopic` RENAME TO `usertopiclink`;
//rename 'usertopiclink.person_id' to 'usertopiclink.user_id'
ALTER TABLE `usertopiclink` CHANGE COLUMN `person_id` `user_id` INT(10) NOT NULL DEFAULT 0;

//rename 'publication.pub_type' to 'publication.report_type'
ALTER TABLE `publication` CHANGE COLUMN `pub_type` `report_type` VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL DEFAULT '';

//rename 'author.ID' to 'author.author_id'
ALTER TABLE `author` CHANGE COLUMN `ID` `author_id` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT;

//====modify the attachments table. This one is actually quite complicated, so it is split up in several statements

//modify the tables

ALTER TABLE `publicationfile` DROP PRIMARY KEY;
ALTER TABLE `publicationfile` ADD COLUMN `att_id` INTEGER UNSIGNED NOT NULL DEFAULT 0 AFTER `isremote`;
ALTER TABLE `publicationfile` MODIFY COLUMN `att_id` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
 ADD PRIMARY KEY(`att_id`);
ALTER TABLE `publicationfile` RENAME TO `attachments`;
ALTER TABLE `attachments` CHANGE COLUMN `person_id` `user_id` INTEGER NOT NULL DEFAULT 0;

//because every attachment can belong to at most one publication, we don't bother making a separate 
//publicationattachmentlink table for now

SET VERSION TO V2.0 if all of the above is done!!!!
otherwise checkschema will complain :)

//changes for introducing new rights management: access_level per object

ALTER TABLE `publication` CHANGE COLUMN `entered_by` `user_id` INTEGER UNSIGNED NOT NULL DEFAULT 0;
ALTER TABLE `personpublicationnote` CHANGE COLUMN `person_id` `user_id` INTEGER NOT NULL DEFAULT 0;
ALTER TABLE `topics` ADD COLUMN `user_id` INTEGER UNSIGNED NOT NULL DEFAULT 0 AFTER `url`;
    -- niet vergeten bij topics: een owner instellen! waarschijnlijk wordt dat de database_manage user die de update uitvoert?

ALTER TABLE `attachments` ADD COLUMN `read_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `att_id`;
ALTER TABLE `publication` ADD COLUMN `read_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `cleantitle`;
ALTER TABLE `topics` ADD COLUMN `read_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `user_id`;
ALTER TABLE `personpublicationnote` ADD COLUMN `read_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `text`;
ALTER TABLE `attachments` ADD COLUMN `edit_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `att_id`;
ALTER TABLE `publication` ADD COLUMN `edit_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `cleantitle`;
ALTER TABLE `topics` ADD COLUMN `edit_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `user_id`;
ALTER TABLE `personpublicationnote` ADD COLUMN `edit_access_level` ENUM('private','public','intern','group') NOT NULL DEFAULT 'intern' AFTER `text`;

UPDATE topics SET read_access_level = 'public' WHERE topic_id = 1

INSERT INTO `availablerights` (`name`,`description`) VALUES 
 ('attachment_read_all','read all attachments, overriding access levels'),
 ('topic_read_all','read all topics, overriding access levels'),
 ('note_read_all','read all notes, overriding access levels');
 
ALTER TABLE `personpublicationnote` RENAME TO `notes`;

//the notes.rights must be transferred to notes.read_access_level and notes.edit_access_level
UPDATE notes SET (read_access_level='private',edit_access_level='private') WHERE rights='private';

//rename 'publication.type' to 'publication.pub_type'
ALTER TABLE `publication` CHANGE `type` `pub_type` ENUM( 'Article', 'Book', 'Booklet', 'Inbook', 'Incollection', 'Inproceedings', 'Manual', 'Mastersthesis', 'Misc', 'Phdthesis', 'Proceedings', 'Techreport', 'Unpublished' ) CHARACTER SET latin1 COLLATE latin1_general_ci NULL DEFAULT NULL 

INSERT INTO `availablerights` (`name`,`description`) VALUES 
 ('attachment_edit_all','edit all attachments, overriding access levels'),
 ('topic_edit_all','edit all topics, overriding access levels'),
 ('note_edit_all','edit all notes, overriding access levels');

==tot hier is het noodzakelijk voor het uitvoeren van de laatste code==


drop irrelevant legacy columns
drop col 'users.u_rights'
drop col 'users.csname'
drop col 'notes.rights'